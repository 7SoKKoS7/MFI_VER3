# MFI_VER3 — MasterForex-V Modular Indicator (MetaTrader 5)

## ⚠️ ВАЖНОЕ ПРЕДУПРЕЖДЕНИЕ

**Данный проект строго MQL5-only (.mq5/.mqh файлы). Любые попытки использовать C/C++/Python/скрипты или другие языки программирования НЕ ДОПУСКАЮТСЯ и будут отклонены.**

## Описание

MFI_VER3 — это модульная реализация индикатора MasterForex-V для MetaTrader 5, основанная на стратегии MasterForex-V. Индикатор использует мультитаймфреймовый анализ и систему MF-pivot для генерации торговых сигналов.

### Основные принципы
- **MF-pivot H/L** — подтвержденные уровни поддержки/сопротивления
- **Trend Up/Down/Flat** — определение направления тренда
- **Фильтры качества** — объем, сессии, схватка, фаза рынка
- **Сигналы** — сильные, обычные, ранние, выходы, развороты

## Структура проекта

```
MFI_VER3/
├─ README.md                    # Этот файл
├─ docs/                        # Документация
│  ├─ Architecture.md          # Архитектура системы
│  ├─ MFV_Method_Summary.md    # Описание методики MF-V
│  ├─ Backtest_Plan.md         # План бэктестинга
│  └─ Contributing.md          # Правила разработки
├─ DataDocs/                    # Документация по данным
│  └─ datasets.md              # Описание исторических данных
├─ data/                        # Исторические данные
│  └─ EURUSD/                  # Данные по EURUSD
│     ├─ EURUSDM1.csv          # 1-минутные данные
│     ├─ EURUSDM5.csv          # 5-минутные данные
│     ├─ EURUSDM15.csv         # 15-минутные данные
│     ├─ EURUSDM30.csv         # 30-минутные данные
│     ├─ EURUSDH1.csv          # Часовые данные
│     ├─ EURUSDH4.csv          # 4-часовые данные
│     ├─ EURUSDDaily.csv       # Дневные данные
│     ├─ EURUSDWeekly.csv      # Недельные данные
│     └─ EURUSDMonthly.csv     # Месячные данные
└─ indicator/                   # Код индикатора
   ├─ MFI_Modular.mq5          # Главный файл индикатора
   └─ include/                 # Модули
      ├─ core/                 # Основные модули
      │  ├─ Types.mqh         # Типы и перечисления
      │  ├─ Config.mqh        # Input параметры
      │  ├─ State.mqh         # Глобальное состояние
      │  ├─ Utils.mqh         # Утилиты
      │  ├─ MarketData.mqh    # Рыночные данные
      │  ├─ ZigZagAdapter.mqh # Адаптер ZigZag
      │  ├─ ZigZagInternal.mqh # Внутренняя реализация ZigZag
      │  ├─ PivotEngine.mqh   # Движок пивотов
      │  ├─ TrendEngine.mqh   # Движок трендов
      │  ├─ Breakout.mqh      # Логика пробоев
      │  ├─ Filters.mqh       # Основные фильтры
      │  ├─ Signals.mqh       # Генерация сигналов
      │  ├─ Draw.mqh          # Отрисовка графики
      │  ├─ Panel.mqh         # Информационная панель
      │  └─ Logger.mqh        # Логирование
      ├─ features/            # Дополнительные функции
      │  ├─ FastPivot.mqh     # Быстрые пивоты
      │  ├─ SimpleSwing.mqh   # Простые свинги
      │  ├─ VolumeFilter.mqh  # Фильтр объема
      │  ├─ SessionFilter.mqh # Фильтр сессий
      │  ├─ ClinchFilter.mqh  # Фильтр схватки
      │  ├─ PhaseFilter.mqh   # Фильтр фазы
      │  ├─ ImpulseFilter.mqh # Фильтр импульса
      │  └─ Consensus_EMA_RSI.mqh # Консенсус EMA/RSI
      └─ adapters/            # Адаптеры
         ├─ TimeAdapter.mqh   # Адаптер времени
         └─ Safety.mqh        # Безопасность
```

## Жёсткие правила и ограничения

### 1. Технические ограничения
- **Только закрытые бары** — все расчеты на `Close[1]`, никаких `Close[0]`
- **Без перерисовки** — строгая политика no repaint
- **Одна ответственность — один файл** — четкое разделение модулей
- **Порядок include** — строгий порядок подключения модулей
- **Массивы в сигнатурах функций** — передавать ПО ССЫЛКЕ (`type &arr[]`)

### 2. Порядок подключения модулей
```mql5
#include "include/core/Types.mqh"
#include "include/core/Config.mqh"
#include "include/core/State.mqh"
#include "include/core/Utils.mqh"
#include "include/core/MarketData.mqh"
#include "include/core/ZigZagAdapter.mqh"
#include "include/core/PivotEngine.mqh"
#include "include/core/TrendEngine.mqh"
#include "include/core/Breakout.mqh"
#include "include/core/Filters.mqh"
#include "include/core/Signals.mqh"
#include "include/core/Draw.mqh"
#include "include/core/Panel.mqh"
#include "include/core/Logger.mqh"
```

### 3. Правила разработки
- **Графика только в Draw** — единственный модуль для отрисовки
- **Панель только отображает** — никакой логики в Panel
- **Без глобальных синглтонов** — кроме `g_state`
- **Совместимость MT5** — `#property strict`

### 4. Запрещенные конструкции
- `auto` ключевое слово
- STL контейнеры (`std::vector`, `std::string`)
- Лямбда-функции
- Шаблоны (`template`)
- Исключения (`try/catch`)
- Динамическое выделение памяти (`new/delete`)
- **Без `#pragma once`**, используем include-гварды `#ifndef/#define/#endif`.
- **Dummy-plot для компиляции скелета**: минимум 1 plot и 1 buffer с типом `DRAW_NONE`, чтобы индикатор успешно компилировался даже в виде пустого шаблона.

## Исторические данные

В папке `data/EURUSD/` хранятся исторические данные по валютной паре EURUSD в различных таймфреймах. **ВАЖНО**: Эти данные используются ТОЛЬКО для оффлайн-валидирования стратегий и сигналов. Индикатор работает в реальном времени с данными MetaTrader 5 и НЕ использует эти CSV файлы в рантайме.

### Назначение CSV файлов:
- **Валидация стратегий** — проверка эффективности различных настроек
- **Бэктестинг** — анализ качества генерируемых сигналов
- **Оптимизация параметров** — поиск оптимальных значений для фильтров
- **Исследовательские цели** — изучение рыночных паттернов

Подробное описание данных см. в [DataDocs/datasets.md](DataDocs/datasets.md).

## Установка и сборка

### 1. Копирование файлов
Скопируйте папку `indicator/` в директорию `MQL5/Indicators/` вашего MetaTrader 5:
```
MQL5/Indicators/MFI_Modular/
├─ MFI_Modular.mq5
└─ include/
   ├─ core/
   ├─ features/
   └─ adapters/
```

### 2. Компиляция
1. Откройте MetaTrader 5
2. Перейдите в MetaEditor (F4)
3. Откройте файл `MFI_Modular.mq5`
4. Нажмите F7 для компиляции
5. Убедитесь, что нет ошибок и предупреждений

### 3. Установка на график
1. В навигаторе MT5 найдите "MFI_Modular"
2. Перетащите на график или дважды кликните
3. Настройте параметры в диалоге свойств
4. Нажмите OK

### 4. Проверка работы
- Индикатор должен появиться на графике
- Информационная панель должна отображаться
- Проверьте работу на разных таймфреймах (M5, M15, H1, H4, D1)

### 5. Версия индикатора
**Версия индикатора:** указывайте в формате MT5 Market `#property version "1.000"` (строго `xxx.yyy`). При изменениях увеличивайте номер в этом же формате.

## Основные функции

### Мультитаймфреймовый анализ
- **M5, M15, H1** — основные таймфреймы
- **H4, D1** — дополнительные для контекста
- Строгая иерархия: старшие ТФ задают направление, младшие — точки входа

### Система MF-pivot
- **Pivot High (PH), Pivot Low (PL)** — подтвержденные ZigZag-экстремумы
- **Medium Pivot (Mid) = (PH + PL) / 2** — ось клинча внутри диапазона
- **Пивоты считаются только по закрытым барам (no repaint): ZigZag — источник экстремумов, PivotEngine — классификация H/L/M**
- Расчет через ZigZag с адаптивным порогом
- Подтверждение только на закрытых барах
- Кеширование для стабильности

### Правила определения тренда (MF-V, без перерисовки)
- Решения только на **закрытом баре**: используем `Close[1]`. Бар 0 игнорируется.
- Тренд **только по пробою пивотов**:
  - **Up** если `Close[1] > Pivot High + tol`
  - **Down** если `Close[1] < Pivot Low − tol`
  - Иначе **Flat**
- **Толеранс (гистерезис)**: `tol = k_ATR * ATR(14)` (и/или минимальный порог в пунктах).
- **Подтверждение пробоя**: либо 1 закрытие за уровнем + успешный ретест, либо `N` последовательных закрытий за уровнем.
- **Клинч (мертвая зона)**: если `Pivot High − Pivot Low < k_range * ATR`, считаем рынок во флэте; тренд Up/Down не выставляется.
- **ZigZag не задаёт тренд**: наклон последней ноги ZigZag не используется для тренда; ZigZag — только источник экстремумов для PivotEngine.

### Типы сигналов
- **🟡 Сильные сигналы** (желтые стрелки) — сила тренда 3/3
- **🟢 Обычные сигналы покупки** (зеленые стрелки) — сила 1-2/3
- **🔴 Обычные сигналы продажи** (красные стрелки) — сила 1-2/3
- **🔵 Ранние сигналы** (голубые стрелки) — частичное совпадение
- **❌ Сигналы выхода** (серые крестики) — пересечение pivot
- **🔄 Сигналы разворота** (аква стрелки) — изменение тренда

### Фильтры качества
- **Объемный фильтр** — анализ объема на M5, M15, H1
- **Сессионный фильтр** — Лондон, Нью-Йорк, Токио
- **Фильтр схватки** — детекция бокового движения
- **Фильтр фазы** — Flat/Trend определение
- **Фильтр импульса** — анализ структуры A-B-C

## Информационная панель

Индикатор отображает детальную информацию:
- **Тренд H1: ↑ M15: ↑ M5: ↑** — направления трендов (вычисляются по правилам MF-V выше)
- **Pivot <TF>: H=… | M=… | L=…** — уровни пивотов (M виден, если валидны H и L)
- **Сила тренда: 3/3** — оценка силы тренда
- **Объем M5:✓ M15:✓ H1:✓ (3/3)** — подтверждение объема
- **Сессия: ✓** — валидность торговой сессии

## ZigZag — внутренний модуль

В проекте используется **только** внутренний ZigZag (`include/core/ZigZagInternal.mqh`), без `iCustom` и внешних зависимостей.

### Особенности внутреннего ZigZag:
- **Работает на закрытых барах** — строгое соблюдение no repaint политики
- **Параметры Depth/Deviation/Backstep** — стандартные настройки ZigZag
- **Возвращает массивы индексов/цен экстремумов** — для дальнейшей обработки
- **Только поиск экстремумов** — модуль не классифицирует пивоты
- **PivotEngine классифицирует** — экстремумы в High/Low/Medium пивоты
- **Отрисовка/логика отдельно** — модуль только вычисляет экстремумы
- **Без внешних зависимостей** — полностью самодостаточная реализация
- **Используется только внутренний ZigZag** (в проекте `include/core/ZigZagInternal.mqh`), без `iCustom` и DLL; `ZigZagAdapter.mqh` — тонкий шлюз.

### Использование:
```mql5
int extremaCount;
int extremaIdx[];
double extremaPrice[];
ArrayResize(extremaIdx, 100);
ArrayResize(extremaPrice, 100);

bool success = MFV_ZZ_FindExtrema(Symbol(), Period(), 
                                 12, 5, 3,  // Depth, Deviation, Backstep
                                 extremaCount, extremaIdx, extremaPrice);
```

## Пресет MF для ZigZag

Параметры Depth/Deviation/Backstep управляются входами `ZZ_MF_*` по таймфреймам. Ключ `ZZ_UseMF_Preset` включает пресет.

### Рекомендуемые MF-настройки:
- **M5**: Depth=12, Deviation=5, Backstep=3
- **M15**: Depth=12, Deviation=5, Backstep=3  
- **H1**: Depth=24, Deviation=5, Backstep=3
- **H4**: Depth=48, Deviation=5, Backstep=3
- **D1**: Depth=60, Deviation=5, Backstep=3

### Формулировка в свойствах:
"Рекомендуемые MF" — оптимальные настройки ZigZag для каждого таймфрейма согласно методике MasterForex-V.

## Документация

- **[Architecture.md](docs/Architecture.md)** — подробная архитектура системы
- **[MFV_Method_Summary.md](docs/MFV_Method_Summary.md)** — описание методики MasterForex-V
- **[Backtest_Plan.md](docs/Backtest_Plan.md)** — план бэктестинга и валидации
- **[Contributing.md](docs/Contributing.md)** — правила разработки и участия
- **[datasets.md](DataDocs/datasets.md)** — описание исторических данных

## Технические особенности

### No Repaint политика
- Все решения принимаются на закрытых барах
- Использование `Close[1]` вместо `Close[0]`
- Подтверждение только после закрытия бара

### Кеширование
- Глобальные переменные терминала
- Кеш пивотов между переключениями ТФ
- Быстрый старт с кешированными значениями

### Производительность
- Оптимизированные расчеты ZigZag
- Мемоизация результатов
- Троттлинг обновлений

## Соответствие стратегии MasterForex-V

- **Мультитаймфреймовый анализ** согласно методике
- **Система MF-pivot** с авторским алгоритмом
- **Профессиональные фильтры** качества сигналов
- **Информационная панель** с детальной статистикой
- **Анализ объема** на ключевых таймфреймах

## Иерархия надежности сигналов

| Тип сигнала | Цвет | Надежность | Рекомендация |
|-------------|------|------------|--------------|
| **Сильный** | 🟡 Желтый | Очень высокая | ✅ Лучший сигнал |
| **Обычный** | 🟢 Зеленый/🔴 Красный | Высокая | ✅ Хороший сигнал |
| **Ранний** | 🔵 Голубой | Средняя | ⚠️ Осторожно |
| **Выход** | ⚫ Серый крестик | Высокая | ❌ Закрыть позицию |
| **Разворот** | 🔵 Аква | Средняя | 🔄 Внимание |

## Лицензия

Индикатор основан на стратегии MasterForex-V и предназначен для образовательных целей.

## Поддержка

Если у вас есть вопросы или предложения по улучшению индикатора:
1. Создайте Issue в репозитории
2. Опишите проблему подробно
3. Приложите примеры кода при необходимости

---

**Совместимость:** MetaTrader 5  
**Автор:** Основан на стратегии MasterForex-V  
**Статус:** Bootstrap завершен, готов к разработке

**Примечание:** это НЕ #property version. Фактическая версия задаётся в MFI_Modular.mq5 в формате xxx.yyy.